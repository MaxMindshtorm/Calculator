# Сервис Калькулятора с Оркестратором и Агенты

## Обзор

Этот проект реализует систему распределённого калькулятора, предназначенную для обработки арифметических выражений в среде, где арифметические операции занимают значительное время и требуют вычислительных ресурсов. Система состоит из двух основных компонентов:

1. **Оркестратор** – сервер, который принимает арифметические выражения, разбивает их на отдельные операции и управляет их выполнением.
2. **Агент** – сервис, который запрашивает задачи у оркестратора, выполняет вычисления и возвращает результаты.

Система разработана для эффективной обработки долгих вычислений за счёт параллельного выполнения независимых частей выражений.

## Архитектура системы

```
┌────────────┐         ┌────────────────┐         ┌────────────┐
│            │ HTTP    │                │ HTTP    │            │
│   Клиент   ├────────►│   Оркестратор  ├────────►│   Агенты   │
│            │ Запрос  │                │ Задачи  │            │
└────────────┘         └────────────────┘         └────────────┘
                               ▲                        │
                               │                        │
                               └────────────────────────┘
                                   Результаты через HTTP
```

## Возможности

- Разбор и вычисление арифметических выражений (сложение, вычитание, умножение, деление)
- Асинхронное выполнение вычислений
- Параллельное выполнение независимых операций
- Масштабируемость за счёт добавления новых вычислительных агентов
- RESTful API для отправки выражений на вычисление и проверки статуса

## API Оркестратора

### Публичные эндпоинты

#### Отправка выражения на вычисление
```
POST /api/v1/calculate
Content-Type: application/json
{
  "expression": "2 + 2 * 2"
}
```

**Коды ответа:**
- 201: Выражение принято на вычисление
- 422: Некорректные данные
- 500: Внутренняя ошибка сервера

**Тело ответа:**
```json
{
  "id": "123"
}
```

#### Получение списка всех выражений
```
GET /api/v1/expressions
```

**Коды ответа:**
- 200: Успешный запрос
- 500: Внутренняя ошибка сервера

**Тело ответа:**
```json
{
  "expressions": [
    {
      "id": "123",
      "status": "completed",
      "result": 6
    },
    {
      "id": 124,
      "status": "in_progress",
      "result": null
    }
  ]
}
```

#### Получение информации о конкретном выражении по ID
```
GET /api/v1/expressions/:id
```

**Коды ответа:**
- 200: Успешный запрос
- 404: Выражение не найдено
- 500: Внутренняя ошибка сервера

**Тело ответа:**
```json
{
  "expression": {
    "id": "123",
    "status": "completed",
    "result": 6
  }
}
```

### Внутренние эндпоинты (для взаимодействия Оркестратора и Агентов)

#### Запрос задачи для выполнения
```
GET /internal/task
```

**Коды ответа:**
- 200: Задача успешно получена
- 404: Нет доступных задач
- 500: Внутренняя ошибка сервера

**Тело ответа:**
```json
{
  "task": {
    "id": 456,
    "arg1": "2",
    "arg2": "2",
    "operation": "multiplication",
    "operation_time": 5000
  }
}
```

#### Отправка результата вычисления
```
POST /internal/task
Content-Type: application/json
{
  "id": "456",
  "result": 4
}
```

**Коды ответа:**
- 200: Результат успешно записан
- 404: Задача не найдена
- 422: Некорректные данные
- 500: Внутренняя ошибка сервера

## Агент

Агент представляет собой фоновый процесс, который:
1. Запускает несколько горутин для параллельных вычислений.
2. Постоянно запрашивает у оркестратора новые задачи.
3. Выполняет вычисления в зависимости от указанной операции.
4. Отправляет результаты обратно оркестратору.

## Переменные окружения

### Оркестратор
- `TIME_ADDITION_MS`: Время выполнения операций сложения (в миллисекундах)
- `TIME_SUBTRACTION_MS`: Время выполнения операций вычитания (в миллисекундах)
- `TIME_MULTIPLICATIONS_MS`: Время выполнения операций умножения (в миллисекундах)
- `TIME_DIVISIONS_MS`: Время выполнения операций деления (в миллисекундах)

### Агент
- `COMPUTING_POWER`: Количество горутин (вычислителей), работающих параллельно

## Последовательность работы

1. Клиент отправляет арифметическое выражение оркестратору.
2. Оркестратор разбирает выражение и разбивает его на отдельные операции.
3. Агенты запрашивают у оркестратора задачи.
4. Получив задачу, агент выполняет вычисление и отправляет результат.
5. Оркестратор объединяет полученные результаты в соответствии со структурой выражения.
6. Клиент периодически запрашивает статус выражения, пока оно не будет вычислено.

## Примечания

- Система имитирует долгие вычисления с помощью настраиваемых задержек.
- Независимые части выражения могут вычисляться параллельно.
- Масштабируемость системы достигается добавлением новых экземпляров агентов.
